name: GitHub ‚Üí Discord

on:
  push:
    branches: [ main ]
  pull_request:
    types: [opened, closed, reopened]
  issues:
    types: [opened, closed, reopened]
  issue_comment:
    types: [created]

jobs:
  discord:
    runs-on: ubuntu-latest
    steps:
      - name: Send message to Discord
        env:
          PUSH_WEBHOOK: ${{ secrets.DISCORD_PUSH_WEBHOOK }}
          PR_WEBHOOK: ${{ secrets.DISCORD_PR_WEBHOOK }}
          ISSUE_WEBHOOK: ${{ secrets.DISCORD_ISSUE_WEBHOOK }}
        run: |
          EVENT="$GITHUB_EVENT_NAME"
          ACTOR="$GITHUB_ACTOR"
          REPO="$GITHUB_REPOSITORY"
          REF="$GITHUB_REF"
          SHA="$GITHUB_SHA"

          if [ "$EVENT" = "push" ]; then
            TITLE="üìå New Push to $REPO"
            URL="https://github.com/$REPO/commit/$SHA"
            COLOR=41983
            DESCRIPTION="A new commit was pushed."
            WEBHOOK="$PUSH_WEBHOOK"

          elif [ "$EVENT" = "pull_request" ]; then
            PR_NUMBER=$(jq -r .pull_request.number "$GITHUB_EVENT_PATH")
            TITLE="üîÄ Pull Request #$PR_NUMBER"
            URL="https://github.com/$REPO/pull/$PR_NUMBER"
            COLOR=8228351
            DESCRIPTION=$(jq -r .pull_request.title "$GITHUB_EVENT_PATH")
            WEBHOOK="$PR_WEBHOOK"

          elif [ "$EVENT" = "issues" ]; then
            ISSUE_NUMBER=$(jq -r .issue.number "$GITHUB_EVENT_PATH")
            TITLE="üìù Issue #$ISSUE_NUMBER"
            URL="https://github.com/$REPO/issues/$ISSUE_NUMBER"
            COLOR=16747527
            DESCRIPTION=$(jq -r .issue.title "$GITHUB_EVENT_PATH")
            WEBHOOK="$ISSUE_WEBHOOK"

          elif [ "$EVENT" = "issue_comment" ]; then
            ISSUE_NUMBER=$(jq -r .issue.number "$GITHUB_EVENT_PATH")
            USER=$(jq -r .comment.user.login "$GITHUB_EVENT_PATH")
            COMMENT_BODY=$(jq -r .comment.body "$GITHUB_EVENT_PATH")

            TITLE="üí¨ New Comment on Issue #$ISSUE_NUMBER"
            URL="https://github.com/$REPO/issues/$ISSUE_NUMBER"
            COLOR=10197915
            DESCRIPTION="**$USER commented:**\n$COMMENT_BODY"
            WEBHOOK="$ISSUE_WEBHOOK"
          fi

          AVATAR="https://github.com/$ACTOR.png"

          PAYLOAD=$(jq -n \
            --arg title "$TITLE" \
            --arg desc "$DESCRIPTION" \
            --arg repo "$REPO" \
            --arg actor "$ACTOR" \
            --arg url "$URL" \
            --arg avatar "$AVATAR" \
            --arg ref "$REF" \
            --arg sha "$SHA" \
            --argjson color "$COLOR" \
            '{
              "username": "GitHub Bot",
              "embeds": [{
                "title": $title,
                "url": $url,
                "description": $desc,
                "color": $color,
                "author": {
                  "name": $actor,
                  "icon_url": $avatar
                },
                "fields": [
                  {"name": "üì¶ Repository", "value": $repo, "inline": true},
                  {"name": "üîÄ Ref / Branch", "value": $ref, "inline": true},
                  {"name": "üß© Commit SHA", "value": $sha, "inline": false}
                ],
                "thumbnail": { "url": $avatar }
              }]
            }')

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$PAYLOAD" \
               "$WEBHOOK"
